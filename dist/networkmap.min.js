/*! networkmap 2013-08-12 */
var networkMap=networkMap||{};networkMap.path=function(a){return a.path().attr({fill:"none",stroke:"#000"})},Array.implement("find",function(a){for(var b=0;b<this.length;b++)if(a.call(this,this[b],b,this))return this[b]}),networkMap.datasource=networkMap.datasource||{},networkMap.registerDatasource=function(a,b){networkMap.datasource[a]=function(a,c){"array"!==typeOf(c)&&(c=[c]),b(a,c)}},networkMap.registerDatasource("simulate",function(a,b){b.each(function(b){var c=Math.random();b.callback({url:a,request:b.data,value:c,realValue:Math.round(100*c)+"Mbps"})})}),networkMap.events=networkMap.events||{click:function(a,b){b.options.events.click.href&&(window.location.href=b.options.events.click.href)},hover:function(a,b){var c=document.id("nm-active-hover");if(a.target.instance.attr("id"),c){if(!c||c.retrieve("id")===a.target.instance.attr("id"))return c.store("keep",!0),void 0;c.destroy()}var d=(a.target.getPosition(),a.target.instance),e=d.getSegment(2),f=d.getSegment(3),g=d.getSegment(5),h=d.getSegment(6),i=((e.coords[0]+h.coords[0])/2+(f.coords[0]+g.coords[0])/2)/2,j=((e.coords[1]+h.coords[1])/2+(f.coords[1]+g.coords[1])/2)/2;c=new Element("div",{id:"nm-active-hover","class":"nm-hover",text:b.options.name,events:{mouseover:function(){c.store("mouseover",!0)},mouseout:function(){c.eliminate("mouseover"),function(){c.retrieve("keep")?c.eliminate("keep"):c.destroy()}.delay(10)},click:function(){b._clickHandler(a)}}}).store("id",a.target.instance.attr("id")),c.setStyles({top:-1e3,left:-1e3}),document.id(document.body).grab(c);var k=c.getSize();c.setStyles({top:j-k.y/2+a.target.instance.doc().parent.getPosition().y,left:i-k.x/2+a.target.instance.doc().parent.getPosition().x})},mouseover:function(){console.log("mouse over")},mouseout:function(){console.log("mouse out")}},networkMap.registerEvent=function(a,b){if(!networkMap.events[a])throw"Invalid event: "+a+" is not an registered event";"click"===a?networkMap.events[a]=function(a,c){b(a,c)}:"hover"===a?(networkMap.events.mouseover=function(a,c){b(a,c)},networkMap.events.mouseout=function(a){a.target.instance.link,function(){var b=document.id("nm-active-hover");b&&b.retrieve("id")!==a.target.instance.attr("id")||b&&!b.retrieve("mouseover")&&b.destroy()}.delay(10)}):networkMap.events[a]=b},networkMap.registerEvent("click",networkMap.events.click),networkMap.registerEvent("mouseover",networkMap.events.mouseover),networkMap.registerEvent("mouseout",networkMap.events.mouseout),networkMap.registerEvent("hover",networkMap.events.hover),networkMap.colormap=networkMap.colormap||{},networkMap.registerColormap=function(a,b){networkMap.colormap[a]=b},networkMap.colormap.rasta5={translate:function(a){return a?.2>a?networkMap.colormap.rasta5.map[0]:.4>a?networkMap.colormap.rasta5.map[1]:.6>a?networkMap.colormap.rasta5.map[2]:.8>a?networkMap.colormap.rasta5.map[3]:networkMap.colormap.rasta5.map[4]:networkMap.colormap.rasta5.nodata},map:["#3DDE1E","#9BEC1A","#F9EB18","#F98020","#F51329"],limits:[.2,.4,.6,.8,1],nodata:"#C0C0C0"},networkMap.ColorLegend=new Class({Implements:[Options],options:{boxSize:25,margin:10},initialize:function(a,b){if(this.graph=b.graph,delete b.graph,this.setOptions(b),this.colormap=networkMap.colormap[a],!this.colormap)throw'Colormap "'+a+'" is not registerd';this.graph.addEvent("resize",this.move.bind(this)),this.draw()},draw:function(){var a=this.colormap.map,b=this.svg=this.graph.getSVG().group();a.each(function(c,d){b.rect(this.options.boxSize,this.options.boxSize).attr({fill:c,"stroke-width":1}).move(0,(a.length-1-d)*this.options.boxSize),b.line(-5,(a.length-1-d)*this.options.boxSize,0,(a.length-1-d)*this.options.boxSize).attr({stroke:"#000"}),b.text(100*this.colormap.limits[d].toString()+"%").attr({"text-anchor":"end","font-size":this.options.boxSize/2}).move(-this.options.boxSize/2,(a.length-1.3-d)*this.options.boxSize,"end")}.bind(this)),b.line(-5,a.length*this.options.boxSize,0,a.length*this.options.boxSize).attr({stroke:"#000"}),b.text("0%").attr({"text-anchor":"end","font-size":this.options.boxSize/2}).move(-this.options.boxSize/2,(a.length-.3)*this.options.boxSize,"end"),this.move()},move:function(a,b){var c;return a&&b||(c=this.graph.element.getSize()),c.x&&c.y&&this.svg.move(c.x-this.options.boxSize-this.options.margin,c.y-this.options.boxSize*this.colormap.map.length-this.options.margin),this}}),networkMap.SettingsManager=new Class({Implements:[Options,Events],options:{},container:null,editing:!1,initialize:function(a){this.container=a,this.nav=this.createMenu(),a.grab(this.nav)},createMenu:function(){var a=new Element("nav",{"class":"nm-menu"}),b=new Element("div",{"class":"nm-trigger",html:'<span class="nm-icon nm-icon-menu"></span><a class="nm-label">Settings</a>',events:{click:this.toggle.bind(this)}}),c=new Element("ul");return c.grab(new Element("ul",{"class":"nm-object-properties",id:"nm-edit-content"})),c.grab(new Element("li",{html:'<button class="btn btn-primary pull-right">Save</button>',"class":"clearfix",events:{click:this.save.bind(this)}})),a.grab(b),a.grab(c),a},edit:function(a){this.editing=a;var b,c={},d=this.nav.getElement("#nm-edit-content");d.empty();var e=function(a,b){return function(){b.setProperty(a,this.value)}};return a.getLink&&(c=a.getLink(),b=c.getEditables(),Object.each(b,function(a,b){d.grab(new Element("li",{text:a.label}));var f=new Element("input",{type:"text",value:c.getProperty(b),events:{change:e(b,c)}});a.disabled===!0&&(f.disabled=!0),d.grab(new Element("li").grab(f))})),b=a.getEditables(),Object.each(b,function(b,c){d.grab(new Element("li",{text:b.label}));var f=new Element("input",{type:"text",value:a.getProperty(c),events:{change:e(c,a)}});b.disabled===!0&&(f.disabled=!0),d.grab(new Element("li").grab(f))}),this},toggle:function(){this.nav.hasClass("nm-menu-open")?this.disable():this.enable()},enable:function(){this.nav.addClass("nm-menu-open"),this.fireEvent("active")},disable:function(){this.nav.removeClass("nm-menu-open"),this.nav.getElement("#nm-edit-content").empty(),this.fireEvent("deactive")},save:function(){this.fireEvent("save")}}),networkMap.Graph=new Class({Implements:[Options,Events],options:{width:10,height:10,datasource:"simulate",colormap:"rasta5",enableEditor:!0,allowDraggableNodes:!1,refreshInterval:null},exportedOptions:[],nodes:[],links:[],saveData:{},initialize:function(a,b){this.setOptions(b),this.element=document.id(a),this.container=new Element("div",{"class":"nm-container"}),this.element.grab(this.container),this.svg=SVG(this.container),this.graph=this.svg.group(),this.options.enableEditor&&(this.legend=new networkMap.ColorLegend(this.options.colormap,{graph:this})),this.settings=new networkMap.SettingsManager(this.container),this.settings.addEvent("active",this.enableEditor.bind(this)),this.settings.addEvent("deactive",this.disableEditor.bind(this)),this.settings.addEvent("save",this.save.bind(this)),this.addEvent("resize",this.rescale.bind(this)),this.triggerEvent("resize",this),this.setRefreshInterval(this.options.refreshInterval)},setRefreshInterval:function(a){return this.options.interval=a,a?this.intervalId=setInterval(function(){this.refresh()}.bind(this),1e3*a):this.intervalId&&(clearInterval(this.intervalId),delete this.intervalId),this},triggerEvent:function(a,b){b.fireEvent(a,b)},rescale:function(){var a=this.element.getSize(),b=this.svg.bbox();return a.x<b.width+b.x||a.y<b.height+b.y?this.svg.viewbox(0,0,b.width+b.x,b.height+b.y):this.svg.viewbox(0,0,a.x,a.y),this.svg.size(a.x,a.y),this},getSVG:function(){return this.svg},getPaintArea:function(){return this.graph},load:function(a){return"string"===typeOf(a)?this.loadUrl(a):void 0},loadUrl:function(a){return new Request.JSON({url:a,onSuccess:function(a){this.loadObject(a)}.bind(this),onFailure:function(){},onComplete:function(){},onError:function(){}}).get({}),this},loadObject:function(a){return a.nodes.each(function(a){a.graph=this,a.draggable=this.options.allowDraggableNodes,this.addNode(new networkMap.Node(a))}.bind(this)),a.links.each(function(a){a.graph=this,this.addLink(new networkMap.Link(a))}.bind(this)),a.onSave&&this.validateSave(a.onSave)&&(this.saveData=a.onSave),this},validateSave:function(a){return a.method&&"post"!=a.method&&"get"!=a.method?(this.saveEnabled=!1,alert("Illigal argument: "+a.method+". Valid onSave.method arguments are: post, get"),!1):(a.method="post",a.data=a.data||{},a.url?!0:(this.saveEnabled=!1,alert("Missing argument onSave.url"),!1))},save:function(){if(!this.saveData)return!1;var a=this.getConfiguration();a.onSave=this.saveData,console.log(a),new Request.JSON({url:this.saveData.url,method:this.saveData.method,data:a,onSuccess:function(a){console.log(a)}.bind(this),onFailure:function(){},onComplete:function(){},onError:function(){}}).send()},enableEditor:function(){this.enableDraggableNodes(),this.nodes.each(function(a){a.mode("edit")}),this.links.each(function(a){a.mode("edit")})},disableEditor:function(){this.disableDraggableNodes(),this.nodes.each(function(a){a.mode("normal")}),this.links.each(function(a){a.mode("normal")})},enableDraggableNodes:function(){this.nodes.each(function(a){a.draggable()})},disableDraggableNodes:function(){this.nodes.each(function(a){a.fixed()})},getConfiguration:function(){var a={nodes:[],links:[]};return this.exportedOptions.each(function(b){a[b]=this.options[b]}.bind(this)),this.nodes.each(function(b){a.nodes.push(b.getConfiguration())}),this.links.each(function(b){a.links.push(b.getConfiguration())}),a},addNode:function(a){return this.nodes.push(a),this},getNode:function(a){return this.nodes.find(function(b){return b.options.id===a?!0:void 0})},addLink:function(a){return this.links.push(a),this},refresh:function(){this.links.each(function(a){a.localUpdate()})},update:function(){var a={};this.links.each(function(b){[b.options.nodeA,b.options.nodeB].each(function(b){a[b.requestUrl]||(a[b.requestUrl]=[]),a[b.requestUrl].push(b.requestData)})}),Object.each(a,function(a,b){a.callback=function(a){console.log(a)},networkMap.datasource[this.options.datasource](b,a)}.bind(this))}}),networkMap.Node=new Class({Implements:[Options,Events],options:{graph:null,id:null,name:null,x:null,y:null,lat:null,lng:null,weight:null,information:{},data:{},label:{position:"internal",visable:!0},renderer:"rect",padding:10,href:null,style:null,debug:!1,draggable:!1,events:null},_mode:"normal",exportedOptions:["id","name","x","y","lat","lng","weight","renderer","information","label","padding","href","style","events"],editTemplate:{id:{label:"ID",type:"text",disabled:!0},name:{label:"Name",type:"text"},padding:{label:"Padding",type:"int"}},initialize:function(a){if(this.graph=a.graph,delete a.graph,this.setOptions(a),!this.options.id)throw"Node(create, no id given)";this.options.x=parseFloat(this.options.x),this.options.y=parseFloat(this.options.y),this.options.padding=parseFloat(this.options.padding),this.graph&&this.draw()},getEditables:function(){return this.editTemplate},setProperty:function(a,b){if(!this.editTemplate[a])throw"Unknow id: "+a;return this.options[a]=b,this.draw(),this},getProperty:function(a){if(!this.editTemplate[a])throw"Unknown id: "+a;return this.options[a]},getConfiguration:function(){var a={};return this.exportedOptions.each(function(b){a[b]=this.options[b]}.bind(this)),a},setGraph:function(a){this.graph=null,this.draw(),a&&(this.graph=a,this.draw())},mode:function(a){if(!a)return this._mode;if("edit"!==a&&"normal"!==a)throw"Unknown mode: "+a;this._mode=a},_clickhandler:function(a){"normal"===this._mode&&this.options.events.click?networkMap.events.click(a).bind(this):"edit"===this._mode&&this.graph.settings.edit(this)},x:function(){return this.svg.bbox().x},y:function(){return this.svg.bbox().y},draggable:function(){this._draggable=!0,this.svg.draggable(),this.svg.style("cursor","move")},fixed:function(){this._draggable=!1,this.svg.fixed(),this.svg.style("cursor","default")},isDraggable:function(){return this._draggable},bbox:function(){return this.svg.bbox()},draw:function(){var a=!1;if(this.svg&&!this.graph)return this.svg.remove(),!1;if(!this.graph)return!1;this.debug&&this.debug.remove(),this.options.debug&&(this.debug=this.graph.getPaintArea().group()),this.svg&&(this.svg.remove(),a=!0);var b=this.svg=this.graph.getPaintArea().group(),c=b.text(this.options.name).font({family:"Helvetica",size:16,anchor:"start",leading:1.2}).move(this.options.padding,this.options.padding),d=c.bbox(),e=b.rect(1,1).fill({color:"#ddd"}).stroke({color:"#000",width:2}).attr({rx:4,ry:4}).size(d.width+2*this.options.padding,d.height+2*this.options.padding);return c.front(),b.on("click",this._clickhandler.bind(this)),this.options.events&&(b.link=this.options.events,this.options.events.click&&b.attr("cursor","pointer")),e.clone().fill({opacity:0}).front(),b.move(this.options.x,this.options.y),this.options.draggable&&this.draggable(),b.dragmove=function(a,b){this.fireEvent("drag",[a,b])}.bind(this),b.dragstart=function(){this.fireEvent("dragstart")}.bind(this),b.dragend=function(){this.options.x=this.x(),this.options.y=this.y(),this.fireEvent("dragend")}.bind(this),this.isDraggable()&&this.draggable(),this.fireEvent("dragend"),!0}}),networkMap.Node.renderer=networkMap.Node.renderer||{},networkMap.registerNodeRenderer=function(a,b){networkMap.Node.renderer[a]=b},networkMap.Node.renderer.rect=function(){},networkMap.Node.label=networkMap.Node.label||{},networkMap.Node.label.rederer=networkMap.Node.label.rederer||{},networkMap.Node.label.rederer.normal=function(){},networkMap.LinkPath=new Class({Implements:[Options,Events],options:{},svg:null,initialize:function(a,b,c){this.setOptions(c),this.link=a,this.svg=b,this.link.registerUpdateEvent(a.options.datasource,this.options.requestUrl,this.options.requestData,function(a){this.link.updateBgColor(this,this.link.options.colormap.translate(a.value))}.bind(this)),this.setupEvents()},getEditables:function(){var a={width:{label:"Local width",type:"int"}};return a},getLink:function(){return this.link},getProperty:function(a){if("width"==a){var b=this.getMainPath();if(b!=this)return b.getProperty(a);if(!this.options[a])return this.link.options[a]}return this.options[a]?this.options[a]:null},setProperty:function(a,b){if("width"==a){var c=this.getMainPath();if(c!=this)return c.setProperty(a,b)}return this.options[a]=b,this.fireEvent("change",[a]),this},getMainPath:function(){var a;return this.link.subpath.nodeA&&(this.link.subpath.nodeA.each(function(b){this==b&&(a=this.link.path.nodeA)}.bind(this)),a)?a:this.link.subpath.nodeB&&(this.link.subpath.nodeB.each(function(b){this==b&&(a=this.link.path.nodeB)}.bind(this)),a)?a:this},setupEvents:function(){this.svg.on("click",this._clickHandler.bind(this)),this.options.events&&(this.options.events.click&&this.svg.attr("cursor","pointer"),this.options.events.hover&&(this.svg.on("mouseover",this._hoverHandler.bind(this)),this.svg.on("mouseout",this._hoverHandler.bind(this))))},_clickHandler:function(a){"normal"===this.link.mode()&&this.options.events&&this.options.events.click?networkMap.events.click(a,this):"edit"===this.link.mode()&&this.link.graph.settings.edit(this)},_hoverHandler:function(a){networkMap.events.mouseover(a,this)}}),networkMap.Link=new Class({Implements:[Options],options:{inset:10,connectionDistance:10,staticConnectionDistance:30,arrowHeadLength:10,width:10,debug:!0,background:"#777",localUpdate:!0,refreshInterval:3e5,datasource:null,colormap:networkMap.colormap.rasta5},exportedOptions:["inset","connectionDistance","staticConnectionDistance","arrowHeadLength","width","background","nodeA","nodeB"],editTemplate:{width:{label:"Width",type:"int"}},pathPoints:[],svgEl:{},updateQ:{},_mode:"normal",path:{},subpath:{},initialize:function(a){var b;if(this.graph=a.graph,a.graph=null,this.options.datasource=this.options.datasource||this.graph.options.datasource,this.svg=this.graph.getPaintArea().group(),!a.nodeA||!a.nodeB)throw"Link(create, missing node in link definition)";if(this.nodeA=this.graph.getNode(a.nodeA.id),!this.nodeA)throw"Link(create, nodeA does not exist ("+this.options.nodeA.id+")";if(b=a.nodeA,this.options.nodeA=b.id,b.sublinks&&(sublinks=b.sublinks,delete b.sublinks,this.subpath.nodeA=[],sublinks.each(function(a){this.subpath.nodeA.push(new networkMap.LinkPath(this,networkMap.path(this.svg),a))}.bind(this))),this.path.nodeA=new networkMap.LinkPath(this,networkMap.path(this.svg),b),(this.options.nodeA.requestData||this.options.nodeA.sublinks)&&(this.svgEl.nodeA={},this.options.nodeA.sublinks&&(this.svgEl.nodeA.sublinks=[])),this.nodeB=this.graph.getNode(a.nodeB.id),!this.nodeB)throw"Link(create, nodeB does not exist ("+this.options.nodeB.id+")";b=a.nodeB,this.options.nodeB=b.id,b.sublinks&&(sublinks=b.sublinks,delete b.sublinks,this.subpath.nodeB=[],sublinks.each(function(a){this.subpath.nodeB.push(new networkMap.LinkPath(this,networkMap.path(this.svg),a))}.bind(this))),this.path.nodeB=new networkMap.LinkPath(this,networkMap.path(this.svg),b),(this.options.nodeB.requestData||this.options.nodeB.sublinks)&&(this.svgEl.nodeB={},this.options.nodeB.sublinks&&(this.svgEl.nodeB.sublinks=[])),this.setOptions(a),this.datasource=networkMap.datasource[this.options.datasource],this.graph&&this.draw()},getEditables:function(){return this.editTemplate},setProperty:function(a,b){if(!this.editTemplate[a])throw"Unknow id: "+a;this.options[a]=b,this.redraw()},getProperty:function(a){if(!this.editTemplate[a])throw"Unknow id: "+a;return this.options[a]},mode:function(a){if(!a)return this._mode;if("edit"!==a&&"normal"!==a)throw"Unknown mode: "+a;this._mode=a},getConfiguration:function(){var a={};return this.exportedOptions.each(function(b){a[b]=this.options[b]}.bind(this)),a},setGraph:function(a){this.graph=null,this.draw(),a&&(this.graph=a,this.draw())},_cleanDebugLayer:function(){this.debug&&this.debug.clear(),this.options.debug&&!this.debug&&(this.debug=this.graph.getPaintArea().group())},redraw:function(){return this.redrawShadowPath(),this.drawMainPath(),this.drawSublinks(),this},draw:function(){if(this.svg&&!this.graph)return this.svg.remove(),!1;if(!this.graph)return!1;this._cleanDebugLayer();var a=this.svg;a.back(),this.nodeA.bbox(),this.nodeB.bbox(),this.shadowPath=a.path().attr({fill:"none",stroke:"#000","stroke-dasharray":"3,5","stroke-width":2}),this.redrawShadowPath().hideShadowPath(),this.drawMainPath(),this.drawSublinks(),this.localUpdate(),this.nodeA.addEvent("drag",function(){this._cleanDebugLayer(),this.redrawShadowPath()}.bind(this)),this.nodeB.addEvent("drag",function(){this._cleanDebugLayer(),this.redrawShadowPath()}.bind(this)),this.nodeA.addEvent("dragstart",function(){this.shadowPath.show(),this.hidePaths()}.bind(this)),this.nodeB.addEvent("dragstart",function(){this.shadowPath.show(),this.hidePaths()}.bind(this)),this.nodeA.addEvent("dragend",function(){this.redrawShadowPath().hideShadowPath(),this.drawMainPath(),this.drawSublinks(),this.showPaths()}.bind(this)),this.nodeB.addEvent("dragend",function(){this.redrawShadowPath().hideShadowPath(),this.drawMainPath(),this.drawSublinks(),this.showPaths()}.bind(this))},redrawShadowPath:function(){this.pathPoints.length=0,networkMap.Point;var a=this.nodeA.bbox(),b=this.nodeB.bbox(),c=SVG.math.angle(a,b);return c=SVG.math.snapToAngle(c,[0,Math.PI/2,Math.PI,3*Math.PI/2]),this.options.inset?this.pathPoints.push(new SVG.math.Point(-this.options.inset*Math.cos(c)+a.cx+Math.cos(c)*a.width/2,-this.options.inset*Math.sin(c)+a.cy+Math.sin(c)*a.height/2)):this.pathPoints.push(new SVG.math.Point(a.cx,a.cy)),this.pathPoints.push(new SVG.math.Point(this.options.connectionDistance*Math.cos(c)+a.cx+Math.cos(c)*a.width/2,this.options.connectionDistance*Math.sin(c)+a.cy+Math.sin(c)*a.height/2)),this.pathPoints.push(new SVG.math.Point(this.options.staticConnectionDistance*Math.cos(c)+a.cx+Math.cos(c)*a.width/2,this.options.staticConnectionDistance*Math.sin(c)+a.cy+Math.sin(c)*a.height/2)),this.pathPoints.push(new SVG.math.Point(-this.options.staticConnectionDistance*Math.cos(-c)+b.cx-Math.cos(-c)*b.width/2,this.options.staticConnectionDistance*Math.sin(-c)+b.cy+Math.sin(-c)*b.height/2)),this.pathPoints.push(new SVG.math.Point(-this.options.connectionDistance*Math.cos(-c)+b.cx-Math.cos(-c)*b.width/2,this.options.connectionDistance*Math.sin(-c)+b.cy+Math.sin(-c)*b.height/2)),this.options.inset?this.pathPoints.push(new SVG.math.Point(this.options.inset*Math.cos(-c)+b.cx-Math.cos(-c)*b.width/2,-this.options.inset*Math.sin(-c)+b.cy+Math.sin(-c)*b.height/2)):this.pathPoints.push(new SVG.math.Point(b.cx,b.cy)),this.shadowPath.clear().M(this.pathPoints[0]).L(this.pathPoints[2]).L(this.pathPoints[3]).L(this.pathPoints[5]),this},removeMainPath:function(){this.mainPathA&&this.mainPathA.remove(),this.mainPathB&&this.mainPathB.remove()},hidePaths:function(){return this.path.nodeA&&this.path.nodeA.svg.hide(),this.subpath.nodeA&&this.subpath.nodeA.each(function(a){a.svg.hide()}),this.path.nodeB&&this.path.nodeB.svg.hide(),this.subpath.nodeB&&this.subpath.nodeB.each(function(a){a.svg.hide()}),this},showPaths:function(){return this.path.nodeA&&this.path.nodeA.svg.show(),this.subpath.nodeA&&this.subpath.nodeA.each(function(a){a.svg.show()}),this.path.nodeB&&this.path.nodeB.svg.show(),this.subpath.nodeB&&this.subpath.nodeB.each(function(a){a.svg.show()}),this},showShadowPath:function(){return this.shadowPath.show(),this},hideShadowPath:function(){return this.shadowPath.hide(),this},drawMainPath:function(){var a,b=1,c=function(a,c){var d=a.getProperty("width"),e=new SVG.math.Line(c[0],c[2]),f=new SVG.math.Line(c[2],c[3]),g=e.perpendicularLine(c[1],b*d),h=e.perpendicularLine(c[2],b*d),i=f.perpendicularLine(c[2],b*d),j=f.midPoint(),k=f.move(j,f.p1,a.link.options.arrowHeadLength);f.move(j,f.p2,a.link.options.arrowHeadLength);var l=f.perpendicularLine(k,b*d),m=new SVG.math.Line(g.p1,h.p1),n=new SVG.math.Line(i.p1,l.p1),o=n.intersection(m);o.parallel===!0&&(o=g.p1),m=new SVG.math.Line(g.p2,h.p2),n=new SVG.math.Line(i.p2,l.p2);var p=n.intersection(m);p.parallel===!0&&(p=g.p2),a.svg.clear(),a.svg.M(c[0]).L(g.p1).L(o).L(l.p1).L(j).L(l.p2).L(p).L(g.p2).Z().front()},d=function(a,b,c){var d=a.getProperty("width"),e=new SVG.math.Line(b[0],b[2]),f=new SVG.math.Line(b[2],b[3]),g=e.perpendicularLine(b[1],c*d),h=e.perpendicularLine(b[2],c*d),i=f.perpendicularLine(b[2],c*d),j=f.midPoint(),k=f.move(j,f.p1,a.link.options.arrowHeadLength);f.move(j,f.p2,a.link.options.arrowHeadLength);var l=f.perpendicularLine(k,c*d/2),m=new SVG.math.Line(b[2],j).midPoint(),n=f.perpendicularLine(m,c*d/2),o=new SVG.math.Line(g.p1,h.p1),p=new SVG.math.Line(i.p1,l.p1),q=p.intersection(o);q.parallel===!0&&(q=g.p1),o=new SVG.math.Line(g.p2,h.p2),p=new SVG.math.Line(i.p2,l.p2);var r=p.intersection(o);r.parallel===!0&&(r=g.p2),a.svg.clear(),a.svg.M(m).L(n.p1).L(l.p1).L(j).L(l.p2).L(n.p2).Z().front()},e=function(){},f=function(){};return this.options.nodeA.requestUrl&&this.options.nodeB.requestUrl?(this.subpath.nodeA?(a=[this.pathPoints[0],this.pathPoints[1],this.pathPoints[2],this.pathPoints[3]],d(this.path.nodeA,a,this.subpath.nodeA.length)):(a=[this.pathPoints[0],this.pathPoints[1],this.pathPoints[2],this.pathPoints[3]],c(this.path.nodeA,a)),this.subpath.nodeB?(a=[this.pathPoints[5],this.pathPoints[4],this.pathPoints[3],this.pathPoints[2]],d(this.path.nodeB,a,this.subpath.nodeB.length)):(a=[this.pathPoints[5],this.pathPoints[4],this.pathPoints[3],this.pathPoints[2]],c(this.path.nodeB,a))):this.options.nodeA.requestUrl&&!this.options.nodeB.requestUrl?this.subpath.nodeA?e():f():this.options.nodeB.requestUrl&&!this.options.nodeA.requestUrl&&(this.subpath.nodeA?e():f()),this},drawSublinks:function(){var a,b,c,d,e,f=function(d,f,g,h){for(var i=0;c>=-a/2;){var j={width:e},k=this.calculateSublinkPath(h,c,j);b&&(d[i].svg.clear(),c===-.5?d[i].svg.M(g).L(b[0]).L(b[1]).L(b[2]).L(h[h.length-1]).L(k[2]).L(k[1]).L(k[0]).Z().back():d[i].svg.M(g).L(b[0]).L(b[1]).L(b[2]).L(k[2]).L(k[1]).L(k[0]).Z().back(),d[i].getProperty("events")&&(d[i].getProperty("events").click&&(d[i].svg.on("click",networkMap.events.click),d[i].svg.attr("cursor","pointer")),d[i].getProperty("events").hover&&(d[i].svg.on("mouseover",networkMap.events.mouseover),d[i].svg.on("mouseout",networkMap.events.mouseout))),i+=1),b=k,c-=1}}.bind(this);return this.subpath.nodeA&&(a=this.subpath.nodeA.length,b=null,c=a/2,d=[this.pathPoints[0],this.pathPoints[1],this.pathPoints[2],new SVG.math.Line(this.pathPoints[2],this.pathPoints[3]).midPoint()],e=this.path.nodeA.getProperty("width")||this.options.width,f(this.subpath.nodeA,this.subpath.nodeA,this.pathPoints[0],d)),this.subpath.nodeB&&(a=this.subpath.nodeB.length,b=null,c=a/2,d=[this.pathPoints[5],this.pathPoints[4],this.pathPoints[3],new SVG.math.Line(this.pathPoints[3],this.pathPoints[2]).midPoint()],e=this.path.nodeB.getProperty("width")||this.options.width,f(this.subpath.nodeB,this.subpath.nodeB,this.pathPoints[5],d)),this},calculateSublinkPath:function(a,b,c){var d=c.width||this.options.width,e=d*b,f=Math.abs(this.options.arrowHeadLength*b*(d/this.options.width)),g=new SVG.math.Line(a[0],a[2]),h=new SVG.math.Line(a[2],a[3]),i=g.perpendicularLine(a[1],e),j=g.perpendicularLine(a[2],e),k=h.perpendicularLine(a[2],e),l=h.move(h.p2,h.p1,f),m=h.perpendicularLine(l,e),n=new SVG.math.Line(i.p1,j.p1),o=new SVG.math.Line(k.p1,m.p1),p=o.intersection(n);return p.parallel===!0&&(p=i.p1),[i.round(2).p1,p.round(2),m.round(2).p1]},setInterval:function(){this.intervalId=setInterval(function(){this.localUpdate()}.bind(this),this.options.refreshInterval)},clearInterval:function(){return this.intervalId&&(clearInterval(this.intervalId),delete this.intervalId),this},registerUpdateEvent:function(a,b,c,d){this.updateQ[a]||(this.updateQ[a]={}),this.updateQ[a][b]||(this.updateQ[a][b]=[]),this.updateQ[a][b].push({data:c,callback:d})},localUpdate:function(){Object.each(this.updateQ,function(a,b){if(!networkMap.datasource[b])throw"Unknown datasource ("+b+")";Object.each(a,function(a,c){this.options.batchUpdate?networkMap.datasource[b](c,a):a.each(function(a){networkMap.datasource[b](c,a)})}.bind(this))}.bind(this))},update:function(){return this.svgEl.nodeA.mainPath&&this.datasource(this.options.nodeA.requestUrl,this.options.nodeA.requestData,function(a){this.updateBgColor(this.svgEl.nodeA.mainPath,this.options.colormap.translate(a.value))}.bind(this)),this.svgEl.nodeA.mainPath&&this.datasource(this.options.nodeB.requestUrl,this.options.nodeB.requestData,function(a){this.updateBgColor(this.svgEl.nodeB.mainPath,this.options.colormap.translate(a.value))}.bind(this)),this.options.nodeA.sublinks&&this.options.nodeA.sublinks.each(function(a,b){this.datasource(this.options.nodeA.sublinks[b].requestUrl,this.options.nodeA.sublinks[b].requestData,function(a){this.updateBgColor(this.svgEl.nodeA.sublinks[b],this.options.colormap.translate(a.value))}.bind(this))}.bind(this)),this.options.nodeB.sublinks&&this.options.nodeB.sublinks.each(function(a,b){this.datasource(this.options.nodeB.sublinks[b].requestUrl,this.options.nodeB.sublinks[b].requestData,function(a){this.updateBgColor(this.svgEl.nodeB.sublinks[b],this.options.colormap.translate(a.value))}.bind(this))}.bind(this)),this},updateBgColor:function(a,b){b?a.svg.fill(b):a.svg.fill(this.options.background)}});